var strata = require('strata');

exports = {
    handlle: function(config, type) {

        var model = config.module.model();
        var list = require(config.path + '/REST/list');

        return function(env, callback) {

            function _on_params(err, params) {
                if (err && strata.handleError(err, env, callback)) {
                    return;
                }

                function _on_find(err, items) {
                    if (err && strata.handleError(err, env, callback)) {
                        return;
                    }

                    if (type == 'format') {
                        var format = env.route.format;
                        if (format == 'json') {
                            callback(200, {}, JSON.stringify(items))
                        } else {
                            redirect.forward(env, callback, '/' + config.module.name);
                        }
                    } else {
                        callback(200, {}, list.render(items, params));
                    }
                    
                }

                var query = list.query(params, env);
                model.find(query, _on_find);
            }

            var req = strata.Request(env);
            req.params(_on_params);

        }
    }
}