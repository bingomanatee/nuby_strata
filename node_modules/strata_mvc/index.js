var fs = require('fs');
var path = require('path');
var util = require('util');
var strata = require('strata');
var ondir = require('strata_mvc/support/ondir');

exports = {
    _app: null,

    load_apps: function(app_path, config, app) {
        app = _init_app(app);
        ondir(app_path, null, function(root) {
            _load_app(root, config, app);
        });
    }
}

function _load_app(root, config, app) {
    var app_info = require(root);

    var loader;
    switch (app_info.type) {
        case 'REST':
            loader = require('strata_mvc/REST');
            break;

        case 'home':
            loader = require('strata_mvc/home');
            break;

        default:
            loader = require('strata_mvc/loader');
    }
    
    loader(root, config, app, app_info);
}

function _init_app(app) {
    if (app) {
        exports._app = app;
    } else if (exports._app) {
        app = exports._app;
    } else {
        app = exports._app = new strata.Builder();
    }
    return app;
}