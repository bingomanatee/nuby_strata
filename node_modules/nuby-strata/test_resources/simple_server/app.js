var Config = require('./config');
var nuby_strata = require('./../../lib');
var strata = require('./../../node_modules/strata');

/**
 * Note - the callback used here is unusual in that
 * the context is being passed to an outside test context.
 * Generally speaking, context is attached to all controllers and actions
 * and this is enough.
 *
 * @param callback
 */
module.exports = function (callback) {
    var config = new Config(__dirname);

    function _on_app(err, context) {
        if (err) return callback(err);

        callback(err, context);
    }

    var context = nuby_strata.context.create(config);

    var app = new strata.Builder();
    app.use(strata.contentType, 'text/plain');
    app.use(strata.contentLength);

    nuby_strata.loader.load_apps(config.app_path, _on_app, context, app);
};