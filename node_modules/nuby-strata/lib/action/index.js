var path = require('path');
//console.log('st_path: %s', st_path);
var strata = require('./../../node_modules/strata');
var _ = require('./../../node_modules/underscore');
var util = require('util');
var action_utils = require('./action_utils');

/**
 * Action is a stock template for handling action related actions.
 * @param config
 */

function Action(config) {
    //  console.log('action on creation: %s', util.inspect(this));
    _.extend(this, config);
    this._init(this);
}

Action.prototype = {

    _init:function (action) {
        if (!action) {
            throw new Error('Action::_init - no action passed');
        }
        if (action.render_by_ct) {
            module.exports.render_by_ct(action);
        }
        if (action.error_by_ct) {
            module.exports.error_by_ct(action);
        }
        if (action.can_by_ct) {
            module.exports.can_by_ct(action);
        }
        if (action.hasOwnProperty('_layout_path') && (!action.layout)) {
            module.exports.add_layout(action);
        }

        action_utils.update_action(this);
    },

    controller:null,
    context:null,

    header:function (env, values) {
        var out = {'Content-Type':'text/html'};
        if (values) {
            _.extend(out, values);
        }
        return out;
    },

    handle:function (type) {
        var action = this;

        return function (env, app_callback) {
            if (action.context && action.context.tracer) {
                action.context.tracer.trace(env, 'handle');
            }
            env._handler_type = type;
            env._action = action;
            env._render_params = {};
            action._handle(env, app_callback);
        }
    },

    _handle:function (env, app_callback) {

        var action = this;

        function _on_params(err, params) {
            action._on_params(err, params, env, app_callback);
        }

        /* !!! FIRST CALL -- starts callback chain */
        var req = new strata.Request(env);
        env._request = req;
        req.params(_on_params);
    },

    _on_params:function (err, params, env, app_callback) {
        var action = this;

        if (err) {
            return action.error(env, {err:err, type:'param_error', method:'_on_params'}, app_callback);
        }

        if (action.context && action.context.tracer) {
            action.context.tracer.trace(env, '_on_params');
        }

        // console.log('_on_params: params %s', util.inspect(params));

        if (env.route) {
            //  console.log('_on_params route: %s', util.inspect(env.route, true, 3));
            for (var p in env.route) {
                switch (p) {
                    case "0":
                    case 0:
                    case "1":
                    case 1:
                    case "2":
                    case 2:
                    case "3":
                    case 3:
                    case "4":
                    case 4:
                    case "5":
                    case 5:
                        break;
                    default:
                        params[p] = env.route[p];
                }
            }

        }
        //console.log('_on_params: %s', util.inspect(params));


        env._request_params = params;

        function _on_can() {
            function _on_data(err, data) {
                action._on_data(err, data, env, app_callback);
            }

            action.data(env, _on_data);
        }

        function _on_block(env) {
            action.error(env, {type:'auth', method:'_on_block'}, app_callback);
        }

        action.can('respond', env, _on_can, _on_block);
    },

    _data_to_env:function (env, data) {
        env._data = data;
    },

    _on_data:function (err, data, env, app_callback) {
        console.log('action::_on_data data = %s', util.inspect(data));
        console.log('app callback: %s', app_callback.toString());
        var action = this;

        if (err) {
            return action.error(env, {err:err, type:'data_error'}, app_callback);
        }

        env._data = data;
        if (action.context && action.context.tracer) {
            action.context.tracer.trace(env, '_on_data');
        }

        if (env.route.hasOwnProperty('format')) {
            console.log('has format');

            var format = env.route.format.toLowerCase();
            action._format(env, format, app_callback);

        } else {
            console.log('route %s has no format', util.inspect(env.route));

            function _on_render(err, content) {
                action._on_render(err, content, env, app_callback);
            }

            this.render(env, _on_render);
        }
    },

    _format:function (env, format, app_callback) {
        var data = env._data;
        var action = this;

        console.log('base action _format; format = %s', util.inspect(format));

        switch (format) {
            case 'json':
                var content = JSON.stringify(data);
                // console.log('content == stringify data: %s', content);
                var header = this.header(content, {'Content-Type':'application/json'});
                app_callback(200, header, content);
                break;

            case 'htm':
            case 'html':

            function _on_render(err, content) {
                action._on_render(err, content, env, app_callback);
            }

                this.render(env, _on_render);
                break;

            default:
                this.error(env, {type:'index_no_format', method:'_format'}, app_callback);

        }
    },

    data:function (env, on_data_callback) {
        on_data_callback(null, {});
    },

    render:function (env, on_render_callback) {
        console.log('render::on_render_callback: %s', on_render_callback.toString());

        return this.context.render(this._view_path, env, on_render_callback, this);
    },

    _on_render:function (err, content, env, app_callback) {
        var action = this;

        function _on_content(err, content) {
            console.log('content recieved: %s', content);
            console.log('_on_content::app_callback: %s', app_callback.toString());
            app_callback(200, action.header(env), content);
        }

        if (err) {
            return action.error(env, {err:err, type:'param_error' }, app_callback);
        } else if (action.hasOwnProperty('layout')) {
            action.layout(env, content, _on_content);
        } else if (this.controller.hasOwnProperty('layout')) {
            action.controller.layout(env, content, _on_content, action);
        } else {
            _on_content(err, content);
        }
    },

    _view_path:null,

    error:function (env, params, callback) {
        console.log("========== ACTION ERROR: %s ========= \n %s",
            params.type, util.inspect(params)
        );
        strata.redirect.forward(env, callback, '/');
    },

    can:function (task, env, if_can, if_block) {
        // console.log('can: env._request_params = %s', JSON.stringify(env._request_params));
        if_can();
    }

}

module.exports = {
    Action:Action,
    create:function (controller, action_path, config) {
        if (!config) {
            config = {type:'default'};
        }

        config.controller = controller;
        config.context = controller.context;
        config.path = action_path;

        var action = new Action(config);
        //     console.log('instantiated action: %s', util.inspect(action, false, 2));
        return action;

    }


}
