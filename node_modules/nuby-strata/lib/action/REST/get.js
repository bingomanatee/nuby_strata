var action = require('./..');
var Action = action.Action;
var _ = require('../../../node_modules/underscore');
var strata = require('./../../../node_modules/strata');
var util = require('util');

function Get_Action(config) {
    //  console.log('action on creation: %s', util.inspect(this));
    _.extend(this, config);
    this._init(this);
}


Get_Action.prototype = _.clone(Action.prototype);

Get_Action.prototype.data = function (env, on_data_callback) {
    var action = this;
    if (this.context && this.context.tracer){
        this.context.tracer.trace(env, 'data');
    }
    this.controller.model.get_id(parseInt(env._request_params.id), function (err, data) {
        action._on_get(err, data, env, on_data_callback);
    });
}

Get_Action.prototype._on_get = function (err, data, env, on_data_callback) {
        var action = this;

        if (err) {
            return action.error(env, {type:'data', subtype:'get_error', err:err, method:'_on_get'}, on_data_callback);
        }

        var id = env._request_params.id;
        if (!id) {
            return action.error(env, {type:'data', subtype:'no_id', method:'_on_get'}, on_data_callback);
        }

        this.controller.model.get_id(id, on_data_callback);
    }

Get_Action.prototype.render = function (env, callback) {
    if (this.context && this.context.tracer){
        this.context.tracer.trace(env, 'render');
    }
    if (this.ticket) {
        env._render_params.ticket = this.ticket(env._render_params.data);
    } else if (this.controller.ticket) {
        env._render_params.ticket = this.controller.ticket(env._render_params.data, env);
    }

    //  console.log('get_action::rendering %s', util.inspect(this.context));

    this.context.render(this._view_path, env, callback, this);
}

module.exports = {
    Get_Action:Get_Action,

    create:function (controller, config, action_path) {

        if (!config) {
            config = {type:'default'};
        }

        config.controller = controller;
        config.context = controller.context;
        config.path = action_path;

        var action = new module.exports.Get_Action(config);
        //  console.log('get controller: %s', util.inspect(action.controller));

        return action;

    }
}