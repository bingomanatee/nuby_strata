var strata = require('./../../node_modules/strata');
var util = require('util');
var proper_path = require('./../support/proper_path');

function Context(config) {
    // console.log('context::const config = %s', util.inspect(config));
    if (config.hasOwnProperty('lang')) {
        this.lang = config.lang;
    }

    if (config.hasOwnProperty('ROOT')) {
        this.ROOT = config.ROOT;
    }

    if (config.hasOwnProperty('auth')) {
        this.resources.auth = config.auth;
    }
    this.config = config;
}

Context.prototype = {
    lang:null,
    ROOT:null,
    models:{},
    controllers:{},
    resources:{},
    static_resources:[],

    run:function () {
        strata.run(this.app, this.config.app_config);
    },
    can:function (task, auth_context, if_can, if_block) {
        if ((!this.auth) || (this.auth(task, auth_context))) {
            if_can();
        } else {
            if_block();
        }
    },
    render:function (view_path, env, callback, action) {
        var nuby_strata = require('./..');
        nuby_strata.render.render_action(view_path, env, callback, action);
    },
    layout:function (layout_path, env, body, callback, action) {
        var nuby_strata = require('./..');
        nuby_strata.render.render_layout(layout_path, env, body, callback, action);
    }

}

module.exports = {
    Context:Context,

    create:function (config) {
        return new Context(config);
    }
}