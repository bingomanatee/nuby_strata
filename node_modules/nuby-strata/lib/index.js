var fs = require('fs');
var path = require('path');
var util = require('util');
var strata = require('./../node_modules/strata');
var ondir = require('./support/ondir');
var loader = require('./loader');

/**
 * nuby_loader: loads all controllers in a path
 */
module.exports = {

    lang:require('./lang'),

    loader:require('./loader'),

    action:require('./action'),

    render:require('./render'),

    context:require('./context'),

    load_apps:function (app_path, callback, context, app) {
        app = _init_app(app, context);
        function on_done_with_ondir() {
            callback(null, app);
        }

        function _on_dir(controller_path, ondir_callback) {
            module.exports.loader.init_controller(controller_path, ondir_callback, context, app);
        }

        ondir(app_path, on_done_with_ondir, null, _on_dir);
    }

}

function _init_app(app, context) {
    if (!app) {
        app = new strata.Builder();
    }
    context.app = app;
    return app;
}