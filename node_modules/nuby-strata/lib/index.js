var fs = require('fs');
var path = require('path');
var util = require('util');
var strata = require('./../node_modules/strata');
var ondir = require('./support/ondir');
var loader = require('./loader');

/**
 * nuby_loader: loads a path based on its configuration.
 */
module.exports = {

    lang:require('./lang'),

    loader:require('./loader'),

    render:require('./render'),

    load_apps:function (app_path, callback, config, app) {
        app = _init_app(app);
    //    console.log('ns::load_apps path: %s', app_path);
    //    console.log('ns::load_apps callback: ', util.inspect(callback));
     //   console.log('ns::load_apps config: ', util.inspect(config));
     //   console.log('ns::load_apps app:', util.inspect(app));
        function on_done_with_ondir() {
       //     console.log('nuby-strata::index all loading done');
            callback(null, app);
        }

        ondir(app_path, on_done_with_ondir, null, function (root, ondir_callback) {
            module.exports.loader.load(root, ondir_callback, config, app);
        });
    }

}

function _init_app(app) {
    if (!app) {
        app = new strata.Builder();
    }
    return app;
}