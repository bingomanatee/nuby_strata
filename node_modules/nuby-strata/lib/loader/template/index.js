var path = require('path');
var proper_path = require('./../../support/proper_path');
var templates = {};

var Template = require('./../../template');

/**
 * note - a template us usually, but not always, a layout.
 * It can serve to format any given bit of material
 *
 * @param template_path
 * @param context -- app context
 * @param callback: function -- returned after template has initialized (once only) or been found.
 */

module.exports = function (template_dir, context, callback) {
    var full_template_dir = context.ROOT + proper_path(template_dir);
    if (templates.hasOwnProperty(template_dir)) {
        callback(null, templates[template_dir]);
    } else {
        path.exists(full_template_dir, function (exists) {
            if (exists) {
                var config = require(full_template_dir);
                var t =  new Template(config, proper_path(template_dir));
                templates[template_dir] = t;
                t.init(context, callback);
            } else {
                throw (new Error('cannot load template ' + template_dir));
            }
        })
    }
}