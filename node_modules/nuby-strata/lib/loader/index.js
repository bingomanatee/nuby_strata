var fs = require('fs');
var path = require('path');
var util = require('util');
var strata = require('./../../node_modules/strata');
var ondir = require('./../support/ondir');

/**
 * Controller Loader
 */
module.exports = {
    controller_loader:function (type) {
        var loader;
        var loader_path;
        type = type.toLowerCase();
        switch (type) {
            case 'rest':
                loader_path = __dirname + '/REST';
                break;

            case 'default':
                loader_path = __dirname + '/default';
                break;

            default:
                throw new Error(util.format('%s: attempt to get unknown loader %s', __dirname, type));
        }

        loader = require(loader_path);
        return loader;
    },

    init_controller:function (controller_path, load_callback, context, app) {
        var controller = require(controller_path);
        controller.path = controller_path;
        controller.context = context;
        var controller_loader = module.exports.controller_loader(controller.type);
        context.controllers[controller.name] = controller;
        controller_loader.load_actions(controller, load_callback, app);
    },

    load_apps:function (app_path, callback, context, app) {
        if (!app) {
            app = new strata.Builder();
        }
        context.app = app;

        function on_done_with_ondir() {
            var app_loader_file = app_path + '/loader.js';
            if (path.existsSync(app_loader_file)) {
                var app_loader = require(app_path + '/loader');
                app_loader(context, callback);
            } else {
            //    console.log('no app loader file %s', app_loader_file);
                callback(null, context);
            }
        }

        function _on_dir(controller_path, ondir_callback) {
            module.exports.init_controller(controller_path, ondir_callback, context, app);
        }

        ondir(app_path, on_done_with_ondir, null, _on_dir);
    },

    template: require('./template'),

    static:require('./static')

}