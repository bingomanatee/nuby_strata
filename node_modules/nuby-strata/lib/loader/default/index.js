var fs = require('fs');
var path = require('path');
var _ = require('underscore');
var util = require('util');
var ondir = require('./../../support/ondir');

/**
 * DEFAULT LOADER: handles a basic controller handler.
 */
module.exports = {

    load_actions:function (controller, callback, context, app) {

        var action_path = controller.path + '/actions';

        function _on_dir(action_item_path, ondir_callback) {
            var action = require(action_item_path);
            action.context = context;
            action.controller = controller;
            if (!action.hasOwnProperty('actions')){
                controller.actions = {};
            }
            controller.actions[action.name] = action;

            if (!(action.handle && (typeof action.handle == 'function'))) {
                throw new Error(util.format('%s: action %s has no function "handle"', __dirname, app_path));
            }

            if (action.hasOwnProperty('get_route')) {
                var route = action.get_route();
            } else {
                var route = '/' + controller.name + '/' + action.name;
            }

            app.route(route, action.handle(), ['GET', 'POST']);
            app.route(route + '.:format', action.handle('format'), ['GET', 'POST']);
            ondir_callback();
        }

        ondir(action_path, callback, null, _on_dir);


        if (!path.existsSync(action_path)) {
            throw new Error(util.format('%s: cannot find action path %s', __dirname, action_path));
        }

    },

    scaffolding:{
        'default':require('./scaffolding/default')
    }
}