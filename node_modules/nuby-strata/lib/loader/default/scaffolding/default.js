var strata = require('../../../../node_modules/strata/lib');
var util = require('util');

module.exports = {
    handle:function (action, type) {

        return function (env, callback) {

            function _on_render(err, out) {
                callback(200, {}, out);
            }

            function _on_can(env) {
              //  console.log('getting data for %s', config.path);
              //  console.log(util.inspect(action));
                action.data(env, function (err, data) {
                  //  console.log('data: %s', util.inspect(data));
                    if (type == 'format') {
                        var format = env.route.format.toLowerCase();
                        switch (format) {
                            case 'json':
                                callback(200, {'Content-Type': 'application/json'}, JSON.stringify(data));
                                break;

                            case 'htm':
                            case 'html':
                                action.render(data, _on_render);
                                break;

                            default:
                                action.error({type:'no_format', env:env, data:data}, callback);

                        }

                    } else {
                        action.render(data, _on_render);
                    }

                });
            }

            function _on_block(env){
                action.error({type: 'auth', env: env}, callback);
            }

            function _on_params(err, params) {
                if (err) {
                    return action.error({env:env, type:'param_error' });
                }

                env.request_params = params;

                action.can('respond', env, _on_can, _on_block);
            }

            var req = new strata.Request(env);
            req.params(_on_params);
        }

    }
}