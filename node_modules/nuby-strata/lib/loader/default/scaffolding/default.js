var strata = require('../../../../node_modules/strata/lib');

module.exports = {
    handle:function (config, type) {

        var action = require(config.path + '/actions/default');

        return function (env, callback) {

            function _on_params(err, params) {
                if (err && strata.handleError(err, env, callback)) {
                    return;
                }

                action.data(env, function (err, data) {
                    if (type == 'format') {
                        var format = env.route.format;
                        if (format == 'json') {
                            callback(200, {}, JSON.stringify(data));
                        } else {
                            throw new Error('cannot handle format ' + type);
                            redirect.forward(env, callback, '/');
                        }
                    } else {
                        action.render(data, function (err, out) {
                            console.log('rendering gives', out);
                            callback(200, {}, out);
                        });
                    }
                });
            }

            var req = new strata.Request(env);
            req.params(_on_params);
        }

    },

    render:function (params) {
        console.log('rendering params', util.inspect(params));
        console.log('smr: %s', util.inspect(smr));
        return smr(__dirname + '/view.html', params);
    }
}